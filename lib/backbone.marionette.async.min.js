// Backbone.Marionette v0.9.0-pre
//
// Copyright (C)2012 Derick Bailey, Muted Solutions, LLC
// Distributed Under MIT License
//
// Documentation and Full License Available at:
// http://github.com/derickbailey/backbone.marionette

Backbone.Marionette.Async=function(a,b,c,d){var e={init:function(){b.Renderer=b.Async.Renderer,c.extend(b.ItemView.prototype,b.Async.ItemView),c.extend(b.CollectionView.prototype,b.Async.CollectionView),c.extend(b.CompositeView.prototype,b.Async.CompositeView)}};return b.Async.ItemView={render:function(){var a=this,c=d.Deferred(),e=function(){a.trigger("before:render",a),a.trigger("item:before:render",a);var b=a.serializeData();d.when(b).then(f)},f=function(c){var e=a.getTemplate(),f=b.Renderer.render(e,c);d.when(f).then(g)},g=function(b){a.$el.html(b),callDeferredMethod(a.onRender,h,a)},h=function(){a.trigger("render",a),a.trigger("item:rendered",a),c.resolve()};return callDeferredMethod(this.beforeRender,e,this),c.promise()}},b.Async.CollectionView={render:function(){var b=this,c=d.Deferred(),e=[],f=this.getItemView(),g=this.options.emptyView||this.emptyView;this.beforeRender&&this.beforeRender(),this.trigger("collection:before:render",this),this.closeChildren();if(this.collection)if(this.collection.length===0&&g){var h=this.addItemView(new a.Model,g);e.push(h)}else this.collection.each(function(a){var c=b.addItemView(a,f);e.push(c)});return c.done(function(){this.onRender&&this.onRender(),this.trigger("collection:rendered",this)}),d.when.apply(this,e).then(function(){c.resolveWith(b)}),c.promise()},addItemView:function(a,b){var c=this,e=this.buildItemView(a,b);this.bindTo(e,"all",function(){var a=slice.call(arguments);a[0]="itemview:"+a[0],a.splice(1,0,e),c.trigger.apply(c,a)}),this.storeChild(e),this.trigger("item:added",e);var f=e.render();return d.when(f).then(function(){c.appendHtml(c,e)}),f}},b.Async.CompositeView={render:function(){var a=this,b=d.Deferred(),c=this.renderModel();return d.when(c).then(function(c){a.$el.html(c),a.trigger("composite:model:rendered"),a.trigger("render");var e=a.renderCollection();d.when(e).then(function(){b.resolve()})}),b.done(function(){a.trigger("composite:rendered")}),b.promise()},renderCollection:function(){var a=b.CollectionView.prototype.render.apply(this,arguments);return a.done(function(){this.trigger("composite:collection:rendered")}),a.promise()}},b.Async.Region={show:function(a){var b=this;this.ensureEl(),this.close(),d.when(a.render()).then(function(){b.open(a),a.onShow&&a.onShow(),a.trigger("show"),b.onShow&&b.onShow(a),b.trigger("view:show",a)}),this.currentView=a}},b.Async.Renderer={render:function(a,c){var e=d.Deferred(),f=b.TemplateCache.get(a);return d.when(f).then(function(a){var b=a(c);e.resolve(b)}),e.promise()}},b.Async.TemplateCache=function(a){this.templateId=a},c.extend(b.Async.TemplateCache,{templateCaches:{},get:function(a){var c=this,d=this.templateCaches[a];return d||(d=new b.TemplateCache(a),this.templateCaches[a]=d),d.load()},clear:function(){var a,b=arguments.length;if(b>0)for(a=0;a<b;a++)delete this.templateCaches[arguments[a]];else this.templateCaches={}}}),c.extend(b.Async.TemplateCache.prototype,{load:function(){var a=this;return this.deferred?this.deferred.promise():(this.deferred=d.Deferred(),this.loadTemplate(this.templateId,function(b){a.template=b,a.deferred.resolve(b)}),this.deferred.promise())},loadTemplate:function(a,b){var c=d(a).html();if(!c||c.length===0){var e="Could not find template: '"+a+"'",f=new Error(e);throw f.name="NoTemplateError",f}c=this.compileTemplate(c),b.call(this,c)},compileTemplate:function(a){return c.template(a)}}),e}(Backbone,Backbone.Marionette,_,window.jQuery||window.Zepto||window.ender)